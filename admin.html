<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Panel</title>
  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    /* === TAMPILAN: tidak diubah dari versi sempurnamu === */
    body {
      margin: 0;
      font-family: "Poppins", sans-serif;
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      background-attachment: fixed;
      background-color: #f4f4f4;
      display: flex;
      min-height: 100vh;
      color: #fff;
      transition: background 0.3s ease-in-out;
    }

    .sidebar {
      width: 240px;
      background: rgba(44, 62, 80, 0.85);
      backdrop-filter: blur(10px);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      box-shadow: 2px 0 10px rgba(0, 0, 0, 0.4);
      border-right: 1px solid rgba(255, 255, 255, 0.1);
      transition: background 0.3s ease-in-out;
    }

    .sidebar-logo img {
      width: 100px;
      height: 100px;
      object-fit: contain;
      filter: drop-shadow(0 0 8px rgba(255, 255, 255, 0.4));
    }

    .sidebar-name {
      margin-top: 10px;
      font-weight: 600;
      color: rgba(255, 255, 255, 0.95);
      text-shadow: 0 0 8px rgba(255, 255, 255, 0.4);
      text-align: center;
    }

    .menu {
      margin-top: 30px;
      width: 100%;
    }

    .menu a {
      display: block;
      padding: 10px 15px;
      color: rgba(255, 255, 255, 0.9);
      text-decoration: none;
      border-radius: 8px;
      text-shadow: 0 0 5px rgba(255, 255, 255, 0.2);
    }

    .menu a:hover {
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
    }

    .content {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      transition: opacity 0.3s ease-in-out;
    }

    .setting-section, .data-section {
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(6px);
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      box-shadow: 0 0 12px rgba(0, 0, 0, 0.3);
      padding: 20px;
      margin-bottom: 20px;
    }

    input, textarea, select {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      margin-bottom: 10px;
      border: 1px solid rgba(255, 255, 255, 0.25);
      background: rgba(255, 255, 255, 0.15);
      color: #fff;
      border-radius: 6px;
    }

    button {
      background: rgba(255, 255, 255, 0.25);
      color: #fff;
      border: 1px solid rgba(255, 255, 255, 0.4);
      padding: 10px 16px;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s ease-in-out;
    }

    button:hover { background: rgba(255, 255, 255, 0.4); }

    label {
      display: block;
      margin-top: 10px;
      font-weight: 500;
      color: rgba(255, 255, 255, 0.95);
      text-shadow: 0 0 6px rgba(255, 255, 255, 0.2);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    table th, table td {
      padding: 8px;
      border: 1px solid rgba(255,255,255,0.2);
      vertical-align: middle;
    }
    table th {
      background: rgba(255,255,255,0.15);
    }

    .actions { display:flex; gap:8px; align-items:center; }

    /* Popup tambah data (form) */
    .modal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.6);
      z-index: 9999;
    }
    .modal .card {
      width: 96%;
      max-width: 480px;
      background: rgba(255,255,255,0.12);
      backdrop-filter: blur(12px);
      padding: 18px;
      border-radius: 12px;
      color: #fff;
      box-shadow: 0 8px 30px rgba(0,0,0,0.4);
    }
    .modal .card h3 { margin-top: 0; text-align:center; }
    .modal .row { display:flex; gap:10px; }
    .modal .row > * { flex:1; }

    /* kecil */
    .btn-small { padding:6px 10px; border-radius:6px; background: rgba(255,255,255,0.18); border:none; color:#fff; cursor:pointer; }
    .btn-save { background: linear-gradient(135deg,#27ae60,#2ecc71); border:none; color:#fff; padding:8px 12px; border-radius:8px; cursor:pointer; }
    .btn-cancel { background: rgba(255,255,255,0.15); border:none; color:#fff; padding:8px 12px; border-radius:8px; cursor:pointer; }

    /* toast */
    .toast { position: fixed; right: 30px; bottom: 30px; background: linear-gradient(135deg,#27ae60,#2ecc71); color:#fff; padding:10px 14px; border-radius:8px; box-shadow:0 6px 20px rgba(0,0,0,0.3); opacity:0; transform:translateY(10px); transition:all .25s; z-index:99999; }
    .toast.show{ opacity:1; transform:translateY(0); }

    @media (max-width: 768px) {
      .sidebar { width:100%; height:auto; flex-direction:row; justify-content:space-around; position:fixed; top:0; z-index:1000; }
      .content { margin-top: 160px; }
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <div class="sidebar-logo"><img id="logoImg" src="" alt="Logo"></div>
    <div class="sidebar-name" id="siteName">Nama Situs</div>
    <div class="menu">
      <a href="#" id="menu-setting"><i class="ri-settings-3-line"></i> Pengaturan</a>
      <a href="#" id="menu-data"><i class="ri-database-2-line"></i> Data Burung</a>
    </div>
  </div>

  <div class="content">
    <!-- KEEP: Setting section exactly like your working version (not changed) -->
    <div class="setting-section" id="settingSection">
      <h2>Pengaturan</h2>
      <!-- your existing setting controls remain here unchanged -->
      <label>Upload Logo:</label>
      <input type="file" id="logoInput" accept="image/*">
      <label>Upload Background:</label>
      <input type="file" id="backgroundInput" accept="image/*">
      <button id="removeBackground">Hapus Background</button>
      <label>Nama:</label><input id="nama" type="text">
      <label>Deskripsi:</label><textarea id="deskripsi"></textarea>
      <label>Kontak:</label><input id="kontak" type="text">
      <label>Lokasi:</label><input id="lokasi" type="text">
      <label>Opacity Background:</label><input type="range" id="bgOpacity" min="0" max="1" step="0.05" value="0.6"><span id="bgOpacityValue">0.6</span>
      <label>Opacity Tampilan:</label><input type="range" id="mainOpacity" min="0" max="1" step="0.05" value="1"><span id="mainOpacityValue">1</span>
      <label>Opacity Sidebar:</label><input type="range" id="sidebarOpacity" min="0" max="1" step="0.05" value="0.85"><span id="sidebarOpacityValue">0.85</span>
      <label>Ukuran Background:</label>
      <select id="bgSize"><option value="cover">Cover</option><option value="contain">Contain</option><option value="auto">Auto</option></select>
      <label>Warna Sidebar:</label><input id="sidebarColor" type="color" value="#2c3e50">
      <label>Warna Background:</label><input id="bgColor" type="color" value="#f4f4f4">
      <button id="saveSettings">Simpan Pengaturan</button>
    </div>

    <!-- Data section (we update only JS-driven behavior) -->
    <div class="data-section" id="dataSection" style="display:none;">
      <h2>Data Burung</h2>
      <div style="display:flex;gap:10px;align-items:center;">
        <input id="searchInput" placeholder="Cari No Ring atau Jenis..." style="flex:1;">
        <button id="addBirdBtn">Tambah Data</button>
      </div>

      <table id="birdTable">
        <thead>
          <tr>
            <th>No Ring</th>
            <th>Jenis</th>
            <th>Gender</th>
            <th>Tgl Lahir</th>
            <th>Indukan Jantan</th>
            <th>Indukan Betina</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Modal / Popup for adding new bird -->
  <div class="modal" id="addModal">
    <div class="card">
      <h3>Tambah Data Burung</h3>
      <label>No Ring</label><input id="new_no_ring" type="text" />
      <label>Jenis</label><input id="new_jenis" type="text" />
      <label>Gender</label><input id="new_gender" type="text" />
      <label>Tgl Lahir (YYYY-MM-DD)</label><input id="new_tgl" type="text" />
      <label>Indukan Jantan</label><input id="new_jantan" type="text" />
      <label>Indukan Betina</label><input id="new_betina" type="text" />
      <div style="display:flex;gap:8px;margin-top:10px;">
        <button class="btn-save" id="saveNewBtn">Simpan</button>
        <button class="btn-cancel" id="cancelNewBtn">Batal</button>
      </div>
    </div>
  </div>

  <!-- Toast container (created dynamically) -->

  <script>
    /* ========== CONFIG ========== */
    const SUPABASE_URL = "https://nobtyozolbbdndfowmho.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5vYnR5b3pvbGJiZG5kZm93bWhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5NjA1NjMsImV4cCI6MjA3ODUzNjU2M30.qwr1OrXwBplwJbcTk6JJOXqRlg5xvzVVsZt9XpteJ40";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    /* ========== UI refs ========== */
    const menuSetting = document.getElementById('menu-setting');
    const menuData = document.getElementById('menu-data');
    const settingSection = document.getElementById('settingSection');
    const dataSection = document.getElementById('dataSection');

    const logoInput = document.getElementById('logoInput');
    const backgroundInput = document.getElementById('backgroundInput');
    const removeBackgroundBtn = document.getElementById('removeBackground');
    const saveSettingsBtn = document.getElementById('saveSettings');

    const addBirdBtn = document.getElementById('addBirdBtn');
    const addModal = document.getElementById('addModal');
    const saveNewBtn = document.getElementById('saveNewBtn');
    const cancelNewBtn = document.getElementById('cancelNewBtn');

    const birdTableBody = document.querySelector('#birdTable tbody');
    const searchInput = document.getElementById('searchInput');

    /* ========== Helpers ========== */
    function showToast(msg, isError = false) {
      const t = document.createElement('div');
      t.className = 'toast';
      t.style.background = isError ? 'linear-gradient(135deg,#e74c3c,#c0392b)' : '';
      t.textContent = msg;
      document.body.appendChild(t);
      setTimeout(()=> t.classList.add('show'), 20);
      setTimeout(()=> { t.classList.remove('show'); setTimeout(()=> t.remove(), 300); }, 3000);
    }

    function safeText(s){ return (s===null || s===undefined) ? '' : String(s); }

    /* ========== LOAD/SETTINGS ========== */
    async function loadSettings() {
      try {
        const { data, error } = await supabase.from('settings').select('*').eq('id',1).single();
        if (error && error.code) { /* ignore if not present */ }
        const s = data || {};
        document.getElementById('nama').value = s.nama || '';
        document.getElementById('deskripsi').value = s.deskripsi || '';
        document.getElementById('kontak').value = s.kontak || '';
        document.getElementById('lokasi').value = s.lokasi || '';
        document.getElementById('bgOpacity').value = s.bg_opacity ?? 0.6;
        document.getElementById('bgOpacityValue').textContent = s.bg_opacity ?? 0.6;
        document.getElementById('mainOpacity').value = s.main_opacity ?? 1;
        document.getElementById('mainOpacityValue').textContent = s.main_opacity ?? 1;
        document.getElementById('sidebarOpacity').value = s.sidebar_opacity ?? 0.85;
        document.getElementById('sidebarOpacityValue').textContent = s.sidebar_opacity ?? 0.85;
        document.getElementById('bgSize').value = s.bg_size || 'cover';
        document.getElementById('sidebarColor').value = s.sidebar_color || '#2c3e50';
        document.getElementById('bgColor').value = s.bg_color || '#f4f4f4';
        if (s.logo_url) document.getElementById('logoImg').src = s.logo_url;
        if (s.nama) document.getElementById('siteName').textContent = s.nama;
        document.body.style.backgroundImage = s.background_url ? `url(${s.background_url})` : 'none';
        document.body.style.backgroundSize = s.bg_size || 'cover';
        document.body.style.backgroundColor = s.bg_color || '#f4f4f4';
        document.querySelector('.content').style.opacity = s.main_opacity ?? 1;
        document.querySelector('.sidebar').style.background = `rgba(44,62,80,${s.sidebar_opacity ?? 0.85})`;
      } catch (e) {
        console.error(e);
      }
    }

    /* ========== SAVE SETTINGS (keep behavior identical) ========== */
    saveSettingsBtn.addEventListener('click', async () => {
      const updates = {
        id:1,
        nama: document.getElementById('nama').value,
        deskripsi: document.getElementById('deskripsi').value,
        kontak: document.getElementById('kontak').value,
        lokasi: document.getElementById('lokasi').value,
        bg_opacity: parseFloat(document.getElementById('bgOpacity').value) || 0.6,
        bg_size: document.getElementById('bgSize').value,
        sidebar_color: document.getElementById('sidebarColor').value,
        bg_color: document.getElementById('bgColor').value,
        main_opacity: parseFloat(document.getElementById('mainOpacity').value) || 1,
        sidebar_opacity: parseFloat(document.getElementById('sidebarOpacity').value) || 0.85
      };
      const { error } = await supabase.from('settings').upsert(updates);
      if (error) showToast('Gagal menyimpan pengaturan', true);
      else { showToast('Pengaturan berhasil disimpan'); loadSettings(); }
    });

    /* ========== Upload Logo & Background (preserve behavior) ========== */
    logoInput.addEventListener('change', async (e) => {
      const file = e.target.files[0]; if (!file) return;
      const path = `logo/${Date.now()}_${file.name}`;
      const { error } = await supabase.storage.from('assets').upload(path, file, { upsert: true });
      if (error) return showToast('Gagal upload logo', true);
      const { data } = supabase.storage.from('assets').getPublicUrl(path);
      await supabase.from('settings').update({ logo_url: data.publicUrl }).eq('id',1);
      document.getElementById('logoImg').src = data.publicUrl;
      showToast('Logo berhasil diunggah');
    });

    backgroundInput.addEventListener('change', async (e) => {
      const file = e.target.files[0]; if (!file) return;
      const path = `background/${Date.now()}_${file.name}`;
      const { error } = await supabase.storage.from('assets').upload(path, file, { upsert: true });
      if (error) return showToast('Gagal upload background', true);
      const { data } = supabase.storage.from('assets').getPublicUrl(path);
      await supabase.from('settings').update({ background_url: data.publicUrl }).eq('id',1);
      document.body.style.backgroundImage = `url(${data.publicUrl})`;
      showToast('Background berhasil diunggah');
    });

    removeBackgroundBtn.addEventListener('click', async () => {
      await supabase.from('settings').update({ background_url: null }).eq('id',1);
      document.body.style.backgroundImage = 'none';
      showToast('Background dihapus');
    });

    /* ========== DATA BURUNG ========== */
    // central load function (always uses latest search)
    async function loadBirds(filter = '') {
      try {
        let q = supabase.from('birds').select('*').order('id',{ascending:false});
        if (filter && filter.trim() !== '') q = q.or(`no_ring.ilike.%${filter}%,jenis.ilike.%${filter}%`);
        const { data, error } = await q;
        if (error) { console.error(error); return; }
        const rows = data || [];
        birdTableBody.innerHTML = '';
        rows.forEach(b => {
          const tr = document.createElement('tr');

          // create cells
          const tdNo = document.createElement('td'); tdNo.contentEditable = true; tdNo.textContent = safeText(b.no_ring);
          const tdJenis = document.createElement('td'); tdJenis.contentEditable = true; tdJenis.textContent = safeText(b.jenis);
          const tdGender = document.createElement('td'); tdGender.contentEditable = true; tdGender.textContent = safeText(b.gender);
          const tdTgl = document.createElement('td'); tdTgl.contentEditable = true; tdTgl.textContent = safeText(b.tgl_lahir);
          const tdJantan = document.createElement('td'); tdJantan.contentEditable = true; tdJantan.textContent = safeText(b.indukan_jantan);
          const tdBetina = document.createElement('td'); tdBetina.contentEditable = true; tdBetina.textContent = safeText(b.indukan_betina);

          const tdActions = document.createElement('td');
          tdActions.className = 'actions';
          const btnSave = document.createElement('button'); btnSave.className='btn-small'; btnSave.textContent='Simpan';
          const btnDelete = document.createElement('button'); btnDelete.className='btn-small'; btnDelete.textContent='Hapus';

          // attach data id via dataset to buttons
          btnSave.dataset.id = b.id;
          btnDelete.dataset.id = b.id;

          // button handlers
          btnSave.addEventListener('click', async (ev) => {
            ev.stopPropagation();
            const id = btnSave.dataset.id;
            const cells = tr.querySelectorAll('td');
            const payload = {
              no_ring: cells[0].textContent.trim(),
              jenis: cells[1].textContent.trim(),
              gender: cells[2].textContent.trim(),
              tgl_lahir: cells[3].textContent.trim(),
              indukan_jantan: cells[4].textContent.trim(),
              indukan_betina: cells[5].textContent.trim()
            };
            const { error } = await supabase.from('birds').update(payload).eq('id', id);
            if (error) showToast('Gagal menyimpan perubahan', true);
            else { showToast('Perubahan disimpan'); loadBirds(searchInput.value); }
          });

          btnDelete.addEventListener('click', async (ev) => {
            ev.stopPropagation();
            if (!confirm('Yakin hapus data ini?')) return;
            const id = btnDelete.dataset.id;
            const { error } = await supabase.from('birds').delete().eq('id', id);
            if (error) showToast('Gagal menghapus data', true);
            else { showToast('Data dihapus'); loadBirds(searchInput.value); }
          });

          tdActions.appendChild(btnSave);
          tdActions.appendChild(btnDelete);

          tr.appendChild(tdNo);
          tr.appendChild(tdJenis);
          tr.appendChild(tdGender);
          tr.appendChild(tdTgl);
          tr.appendChild(tdJantan);
          tr.appendChild(tdBetina);
          tr.appendChild(tdActions);

          birdTableBody.appendChild(tr);
        });
      } catch (err) {
        console.error(err);
      }
    }

    /* ========== ADD NEW (popup form) ========== */
    addBirdBtn.addEventListener('click', () => {
      // clear fields and open modal
      document.getElementById('new_no_ring').value = '';
      document.getElementById('new_jenis').value = '';
      document.getElementById('new_gender').value = '';
      document.getElementById('new_tgl').value = '';
      document.getElementById('new_jantan').value = '';
      document.getElementById('new_betina').value = '';
      addModal.style.display = 'flex';
    });

    cancelNewBtn.addEventListener('click', () => addModal.style.display = 'none');

    saveNewBtn.addEventListener('click', async () => {
      const no_ring = document.getElementById('new_no_ring').value.trim();
      const jenis = document.getElementById('new_jenis').value.trim();
      const gender = document.getElementById('new_gender').value.trim();
      const tgl_lahir = document.getElementById('new_tgl').value.trim();
      const indukan_jantan = document.getElementById('new_jantan').value.trim();
      const indukan_betina = document.getElementById('new_betina').value.trim();

      if (!no_ring) { showToast('No Ring wajib diisi', true); return; }
      // insert
      const { error } = await supabase.from('birds').insert([{ no_ring, jenis, gender, tgl_lahir, indukan_jantan, indukan_betina }]);
      if (error) { showToast('Gagal menambah data', true); console.error(error); return; }
      showToast('Data berhasil ditambahkan');
      addModal.style.display = 'none';
      loadBirds(searchInput.value);
    });

    /* ========== SEARCH handler ========== */
    let searchTimer = null;
    searchInput.addEventListener('input', (e) => {
      clearTimeout(searchTimer);
      searchTimer = setTimeout(()=> loadBirds(e.target.value.trim()), 250);
    });

    /* ========== NAV handlers ========== */
    menuSetting.addEventListener('click', (e) => { e.preventDefault(); settingSection.style.display='block'; dataSection.style.display='none'; });
    menuData.addEventListener('click', (e) => { e.preventDefault(); settingSection.style.display='none'; dataSection.style.display='block'; loadBirds(); });

    /* ========== INITIALIZE ========== */
    (async function init(){
      await loadSettings();
      await loadBirds();
    })();

    /* ========== end script ========== */
  </script>
</body>
</html>
